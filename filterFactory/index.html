<HTML xmlns="http://www.w3.org/1999/xhtml">
<!--
See:
http://www.graficaobscura.com/matrix/
http://srufaculty.sru.edu/david.dailey/svg/SVGOpen2010/Filters2.htm
https://github.com/blueimp/JavaScript-Canvas-to-Blob/blob/master/canvas-to-blob.js
-->
<HEAD>
<META charset="utf-8">
<META name="viewport" content="width=device-width">
<!--
<LINK rel="stylesheet" type="text/css" href="style/fxosstub.css"/>
-->
<!--
<SCRIPT type="text/javascript" src="js/fxosstub.js"></SCRIPT>
-->
<STYLE type="text/css">
html, body {
  font-size: 10px;
  width: 100%;
  padding: 0;
  font-family: "Open Sans", sans-serif;
  overflow: hidden;
}
table {
   border-collapse: collapse;
}
td[disabled] {
   opacity: 0.20;
}
.sliders tr {
   height: 4rem;
   background-color:#D0D0D0;
   border-bottom: solid 0.5rem white;
}
.sliders tr:nth-child(odd) {
   background-color:#B0B0B0;
}
.sliders td:nth-child(odd) {
  border-left: solid 0.5rem white;
  font-size: 1rem;
  font-weight: bold;
  padding: 0 1rem;
}
.sliders td:first-child {
   border: none;
}
.sliders td span {
   font-weight:normal;
   font-size:1.2rem;
   color:#F03030;
}
label {
   font-size: 1rem;
   font-weight: bold;
}
img.filtered {
/*  filter: url(  */
/*     "data:image/svg+xml;utf8,<svg xmlns=\'http://www.w3.org/2000/svg\'><filter id=\'grayscole\'><feColorMatrix type=\'matrix\' values=\'0.6666 0.6666 0.6666 0 0 0.3333 0.3333 0.3333 0 0 0.3333 0.3333 0.3333 0 0 0 0 0 1 0\'/></filter></svg>#grayscole" */
/*  );            */
}
</STYLE>

<SCRIPT type="text/javascript">
var xRW = 0.3086;
var xGW = 0.6094;
var xBW = 0.0820;
var RW = 0.213;
var GW = 0.715;
var BW = 0.072;
var RX = 0.787;  // 1-RW
var GX = 0.285;  // 1-GW
var BX = 0.928;  // 1-BW
var RA = 0.143;
var GA = 0.140;
var BA = 0.283;

var filters = [
   "red", "green", "blue", "brightness", "saturation", "rotateHue",
   "contrast", "blur", "invert", "vignette", "sepia", "dusk", "sharpen",
   "extra1", "extra2", "extra3", "noir", "moat"
];

function multiply(a, b) {
   var t = 0;
   var res = new Float64Array(20);
   for (var i=0, t=0; t < 20; i += 5) {
      for (var j=0; j < 5; ++j, ++t) {
         res[t] = 0;
         for (var k=0, l=i, m=j; k < 4; ++k, ++l, m += 5) {
            res[t] += a[l] * b[m];
         }
      }
      res[t-1] += a[i+4];
   }
   return res;
}

function saturate(s, vals) {
   if (s == 100) {
      return vals;
   }else {
      s /= 100;
      return multiply(
         vals,
         [
            (((1.0-s)*RW) + s), (((1.0-s)*GW)), (((1.0-s)*BW)), 0, 0,
            (((1.0-s)*RW)), (((1.0-s)*GW) + s), (((1.0-s)*BW)), 0, 0,
            (((1.0-s)*RW)), (((1.0-s)*GW)), (((1.0-s)*BW) + s), 0, 0,
            0, 0, 0, 1, 0
         ]
      );
   }
}

function rotateHue(d, vals) {
   var rad = (d * Math.PI) / 180;
   var cos = Math.cos(rad);
   var sin = Math.sin(rad);
   return multiply(
      vals,
      [
         RW+(cos*RX)-(sin*RW), GW-(cos*GW)-(sin*GW), BW-(cos*BW)+(sin*BX), 0, 0,
         RW-(cos*RW)+(sin*RA), GW+(cos*GX)+(sin*GA), BW-(cos*BW)-(sin*BA), 0, 0,
         RW-(cos*RW)-(sin*RX), GW-(cos*GW)+(sin*GW), BW+(cos*BX)+(sin*BW), 0, 0,
         0, 0, 0, 1, 0
      ]
   );
}
function doExtra3(d, vals) {
   if (d != 100) {
      d /= 100;
      vals[0] *= (1-RW) * d;
      vals[6] *= (1-GW) * d;
      vals[11] *= (1-BW) * d;
   }
   return vals;
}

function doDusk(dusk, vals) {
   if (!dusk) {
      return vals;
   }else {
      return multiply(
         vals,
         [
            1.0, 0, 0, 0, 0,
            0, 0.2, 0, 0, 0,
            0, 0, 0.2, 0, 0,
            0, 0, 0, 1, 0
         ]
      );
   }
}

function doSepia(sepia, vals) {
   if (!sepia) {
      return vals;
   }else {
      return multiply(
         vals,
         [
            0.280, 0.450, 0.05, 0, 0,
            0.140, 0.390, 0.04, 0, 0,
            0.080, 0.280, 0.03, 0, 0,
            0, 0, 0, 1, 0
         ]
      );
   }
}

function makeGaussianBlur() {
   var blur = parseInt(document.getElementById("blur").value);
   document.getElementById("blurVal").textContent =  blur.toFixed(0);
   if (blur == 0) {
      return "";
   }else {
      return "<feGaussianBlur stdDeviation='" + blur + "'/>";
   }
}

function makeFilterNoir() {
   var noir = document.getElementById("noir").checked;
   if (noir) {
      return (
         "<feGaussianBlur stdDeviation='1.5'/>" +
         "<feComponentTransfer>" +
           "<feFuncR type='discrete' tableValues='0 .5 1 1'/>" +
           "<feFuncG type='discrete' tableValues='0 .5 1'/>" +
           "<feFuncB type='discrete' tableValues='0'/>" +
         "</feComponentTransfer>"
      );
   }else {
      return "";
   }
}

function makeFilterMoat() {
   var moat = document.getElementById("moat").checked;
   if (moat) {
      return (
         "<feConvolveMatrix order='5'" +
         " kernelMatrix='" +
         "1  1    1     1   1 " +
         "1 -1.2 -1.2  -1.2 1 " +
         "1 -1.2  -3   -1.2 1 " +
         "1 -1.2 -1.2  -1.2 1 " +
         "1  1  1  1  1'/>"
      );
   }else {
      return "";
   }
}

function makeSharpen(sharpen) {
   var isSharpened = document.getElementById("sharpenChk").checked;
   if (isSharpened) {
      var sharpen = parseInt(document.getElementById("sharpen").value);
      document.getElementById("sharpenVal").textContent =  sharpen.toFixed(0);
      return (
         "<feConvolveMatrix order='3'" +
         " kernelMatrix='" +
         " 1 -1  1 " +
         "-1 " + -(sharpen/100) + " -1 " +
         " 1 -1  1'/>"
      );
   }else {
      return "";
   }
}

function makeComponentTransfer() {
   var contrast = parseInt(document.getElementById("contrast").value);
   document.getElementById("contrastVal").textContent =  contrast.toFixed(0);
   contrast = (contrast/2) - 50;
   var slope;
   var intercept;
   if (contrast == 0) {
      return "";
   }else if (contrast < 0) {
      contrast = -contrast;
      contrast /= 100;
      intercept = contrast;
      slope = 1 - (2*contrast);
   }else {
      contrast /= 200;
      slope = 1 / (1 - (2*contrast));
      intercept = (1 - slope) / 2;
   }
   slope = slope.toFixed(4);
   intercept = intercept.toFixed(4);
   return (
      "<feComponentTransfer>" +
      "<feFuncR type='linear' slope='" + slope +
      "' intercept='" + intercept + "'/>" +
      "<feFuncG type='linear' slope='" + slope +
      "' intercept='" + intercept + "'/>" +
      "<feFuncB type='linear' slope='" + slope +
      "' intercept='" + intercept + "'/>" +
      "</feComponentTransfer>"
   );
}

function makeColorMatrix() {
   var oldR = parseInt(document.getElementById("red").value);
   var oldG = parseInt(document.getElementById("green").value);
   var oldB = parseInt(document.getElementById("blue").value);
   var newR = oldR + ((100-oldG)/2) + ((100-oldB)/2);
   var newG = ((100-oldR)/2) + oldG + ((100-oldB)/2);
   var newB = ((100-oldR)/2) + ((100-oldG)/2) + oldB;
   document.getElementById("blueVal").textContent =  100 - (
      parseInt(document.getElementById("redVal").textContent = (newR/3).toFixed(0)) +
      parseInt(document.getElementById("greenVal").textContent = (newG/3).toFixed(0))
   );
   var brightness = parseInt(document.getElementById("brightness").value);
   document.getElementById("brightnessVal").textContent =  brightness.toFixed(0);
   var vals = [
      (newR * (brightness/100))/100, 0, 0, 0, 0,
      0, (newG * (brightness/100))/100, 0, 0, 0,
      0, 0, (newB * (brightness/100))/100, 0, 0,
      0, 0, 0, 1, 0
   ];
   var saturation = parseInt(document.getElementById("saturation").value);
   document.getElementById("saturationVal").textContent =  saturation.toFixed(0);
   var hueRot = parseInt(document.getElementById("rotateHue").value);
   document.getElementById("rotateHueVal").textContent =  hueRot.toFixed(0);
   var extra3 = parseInt(document.getElementById("extra3").value);
   document.getElementById("extra3Val").textContent =  extra3.toFixed(0);
   var sepia = document.getElementById("sepia").checked;
   var dusk = document.getElementById("dusk").checked;

   vals = saturate(saturation, vals);
   vals = rotateHue(hueRot, vals);
   vals = doExtra3(extra3, vals);
   vals = doSepia(sepia, vals);
   vals = doDusk(dusk, vals);
   var isIdentity = true;
   var filterValue = "";
   for (var i=0, j=-1; i < 20; ++i) {
      var v = vals[i];
      if ((i%5) == 0) ++j;
      if ((i%5) == j) { // diagonal
         if (v != 1) isIdentity = false;
      }else {
         if (v != 0) isIdentity = false;
      }
      filterValue += " " + vals[i].toFixed(4);
   }
   if (!isIdentity) {
      return "<feColorMatrix type='matrix' values='" +  filterValue + "'/>"
   }else {
      return ""; // no need for.
   }
}

function filterImage() {
   var filterValue = "";
   var colorMatrix = makeColorMatrix();
   var componentTransfer = makeComponentTransfer();
   var gaussianBlur = makeGaussianBlur();
   var filterNoir = makeFilterNoir();
   var filterMoat = makeFilterMoat();
   var sharpen = makeSharpen();
   if (colorMatrix !== "") {
      filterValue += colorMatrix;
   }
   if (componentTransfer != "") {
      if (filterValue !== "") filterValue += "\r\n";
      filterValue += componentTransfer;
   }
   if (gaussianBlur != "") {
      if (filterValue !== "") filterValue += "\r\n";
      filterValue += gaussianBlur;
   }
   if (filterNoir != "") {
      if (filterValue !== "") filterValue += "\r\n";
      filterValue += filterNoir;
   }
   if (filterMoat != "") {
      if (filterValue !== "") filterValue += "\r\n";
      filterValue += filterMoat;
   }
   if (sharpen != "") {
      if (filterValue !== "") filterValue += "\r\n";
      filterValue += sharpen;
   }
   document.getElementById("filterValue").innerHTML = filterValue;
   if (filterValue === "") {
      var images = document.querySelectorAll("img.filtered");
      for (var i=0, max=images.length; i < max; ++i) {
         var img = images[i];
         img.style.filter = "";
      };
   }else {
      var url = (
         "data:image/svg+xml;utf8,<svg xmlns='http://www.w3.org/2000/svg'>" +
         "<filter id='f0'>" +
         colorMatrix +
         componentTransfer +
         gaussianBlur +
         filterNoir +
         filterMoat +
         sharpen +
         "</filter></svg>#f0"
      );
      var images = document.querySelectorAll("img.filtered");
      for (var i=0, max=images.length; i < max; ++i) {
         var img = images[i];
         img.style.filter = "url(\"" + url + "\")";
      };
   }
}

window.onload = function() {
   filters.forEach(
      function(name) {
         if ((name == "sepia") || (name == "dusk") || (name == "noir") || (name == "moat")) {
            document.getElementById(name).addEventListener('change', filterImage);
         }else {
            document.getElementById(name).addEventListener('input', filterImage);
            if (name == "sharpen") {
               document.getElementById(name+"Chk").addEventListener('change', filterImage);
            }
         }
      }
   );
   filterImage();
}

</SCRIPT>

<TITLE>Testing Filters<</TITLE>
</HEAD>

<BODY>
<DIV>
    <TABLE style="width: 85%;margin:auto">
      <TBODY>
         <TR><TD colspan=2>

            <TEXTAREA readonly
               placeholder="Please use Firefox Nightly for rendering the sliders"
               id="filterValue" rows="4" style="width:100%;margins:auto"></TEXTAREA>
            <!-- BUTTON onclick="filterImage();">Refresh</button -->
         </TD></TR>
         <TR><TD>
               <!-- style="width: 100%;" -->
            <IMG
               src="Cirques.jpg"
               alt="Cirques"
            />
         </TD><TD>
            <DIV style="position:relative">
               <!-- style="position:absolute;left:0px;top:0px" -->
            <IMG
               class = "filtered"
               src="Cirques.jpg"
               alt="Cirques"
            />
            <DIV id="over1" style="position:absolute; left:0; top:0;z-index:10"/>
               <IMG src="Vignette.png" style="visibility:hidden"/>
            </DIV>
            </DIV>
         </TD></TR>
         <TR><TD >
            <IMG
               style="width: 100%;"
               src="ClownFishes.jpg"
               alt="Clown Fishes"
            />
         </TD><TD>
            <DIV style="position:relative">
               <!-- style="width: 100%; position:absolute;left:0px;top:0px" -->
            <IMG
               class = "filtered"
               src="ClownFishes.jpg"
               alt="Clown Fishes"
            />
            <DIV id="over1" style="position:absolute; left:0; top:0;z-index:10"/>GOOD BYE.</DIV>
            </DIV>
         </TD></TR>
         <TR><TD colspan="2" style="height:0.5rem"></TD></TR>
         <TR><TD colspan="2">
            <TABLE class="sliders" width="100%">
               <TBODY>
                 <TR><TD>Red</TD><TD><INPUT id="red" type="range" value="33" min="0" max="100" step="1"/><SPAN id=redVal></SPAN>
                 </TD><TD>Saturation</TD><TD><INPUT id="saturation" value="100" type="range"  min="-100" max="100"/><SPAN id="saturationVal"></SPAN>
                 </TD><TD>Sharpen<INPUT id="sharpenChk" type="checkbox"/>
                 </TD><TD><INPUT id="sharpen" type="range" value="100" min="0" max="100"/><SPAN id=sharpenVal></SPAN>
                 </TD></TR>
                 <TR><TD>Green</TD><TD><INPUT id="green" type="range" value="33" min="0" max="100" step="1"/><SPAN id="greenVal"></SPAN>
                 </TD><TD>Hue Rotation</TD><TD><INPUT id="rotateHue" type="range" value="0" min="0" max="360"/><SPAN id="rotateHueVal"></SPAN>
<!--
                 </TD><TD disabled="disabled">Vignette</TD><TD disabled="disabled"><INPUT id="vignette" type="range" min="0" max="100"/><SPAN id="vignetteVal"></SPAN>
-->
                 </TD><TD colspan="2" align="center"><LABEL><INPUT id="vignette" type="checkbox"/>Vignette</LABEL></TD>
                 </TD></TR>
                 <TR><TD>Blue</TD><TD><INPUT id="blue" type="range" value="33" min="0" max="100" step="1"/><SPAN id="blueVal"></SPAN>
                 </TD><TD>Contrast</TD><TD><INPUT id="contrast" value="100" type="range" min="-200" max="299"/><SPAN id="contrastVal"></SPAN>
                 </TD><TD disabled="disabled">Invert</TD><TD disabled="disabled"><INPUT id="invert" type="range" min="0" max="100"/><SPAN id="invertVal"></SPAN>
                 </TD></TR>
                 <TR><TD>Brightness</TD><TD><INPUT id="brightness" value="100" type="range"  min="0" max="100"/><SPAN id="brightnessVal"></SPAN>
                 </TD><TD>Blur</TD><TD><INPUT id="blur" value="0" type="range" min="0" max="10"/><SPAN id=blurVal></SPAN>
                 </TD><TD colspan="2">
                    <LABEL><INPUT id="sepia" type="checkbox"/>Sepia</LABEL>
                    &nbsp; &nbsp;
                    <LABEL><INPUT id="dusk" type="checkbox"/>Dusk</LABEL>
                    &nbsp; &nbsp;
                    <LABEL><INPUT id="noir" type="checkbox"/>Noir</LABEL>
                    &nbsp; &nbsp;
                    <LABEL><INPUT id="moat" type="checkbox"/>Moat</LABEL>
                 </TD></TR>
                 <TR><TD disabled="disabled">Extra1</TD><TD disabled="disabled"><INPUT id="extra1" type="range" min="0" max="100"/><SPAN id=blurVal></SPAN>
                 </TD><TD disabled="disabled">Extra2</TD><TD disabled="disabled"><INPUT id="extra2" type="range" min="0" max="100"/><SPAN id=blurVal></SPAN>
                 </TD><TD>Extra3</TD><TD><INPUT id="extra3" value="100" type="range" min="0" max="500"/><SPAN id="extra3Val"></SPAN>
                 </TD></TR>
               </TBODY>
            </TABLE>
         </TD></TR>
      </TBODY>
    </TABLE>
  </DIV>
</BODY></HTML>

