<HTML xmlns="http://www.w3.org/1999/xhtml">
<!--
See:
http://www.graficaobscura.com/matrix/
http://srufaculty.sru.edu/david.dailey/svg/SVGOpen2010/Filters2.htm
https://github.com/blueimp/JavaScript-Canvas-to-Blob/blob/master/canvas-to-blob.js
-->
<HEAD>
<META charset="utf-8">
<META name="viewport" content="width=device-width">
<!--
<LINK rel="stylesheet" type="text/css" href="style/fxosstub.css"/>
-->
<!--
<SCRIPT type="text/javascript" src="js/fxosstub.js"></SCRIPT>
-->
<STYLE type="text/css">
html, body {
  font-size: 10px;
  width: 100%;
  padding: 0;
  font-family: "Open Sans", sans-serif;
  overflow: hidden;
}
table {
   border-collapse: collapse;
}
td[disabled] {
   opacity: 0.20;
}
.sliders tr {
   height: 4rem;
   background-color:#D0D0D0;
   border-bottom: solid 0.5rem white;
}
.sliders tr:nth-child(odd) {
   background-color:#B0B0B0;
}
.sliders td:nth-child(odd) {
  border-left: solid 0.5rem white;
  font-size: 1rem;
  font-weight: bold;
  padding: 0 1rem;
}
.sliders td:first-child {
   border: none;
}
.sliders td span {
   font-weight:normal;
   font-size:1.2rem;
   color:#F03030;
}
img.filtered {
    filter: url(
       "data:image/svg+xml;utf8,<svg xmlns=\'http://www.w3.org/2000/svg\'><filter id=\'grayscole\'><feColorMatrix type=\'matrix\' values=\'0.6666 0.6666 0.6666 0 0 0.3333 0.3333 0.3333 0 0 0.3333 0.3333 0.3333 0 0 0 0 0 1 0\'/></filter></svg>#grayscole"
    );
}
</STYLE>

<SCRIPT type="text/javascript">
var xRW = 0.3086;
var xGW = 0.6094;
var xBW = 0.0820;
var RW = 0.213;
var GW = 0.715;
var BW = 0.072;
var RX = 0.787;  // 1-RW
var GX = 0.285;  // 1-GW
var BX = 0.928;  // 1-BW
var RA = 0.143;
var GA = 0.140;
var BA = 0.283;

var filters = [
   {
      name: "red",
      doFilter: function() {
         return doColorMatrix();
      }
   }, {
      name: "green",
      doFilter: function() {
         return doColorMatrix();
      }
   }, {
      name: "blue",
      doFilter: function() {
         return doColorMatrix();
      }
   }, {
      name: "brightness",
      doFilter: function() {
         return doColorMatrix();
      }
   }, {
      name: "saturation",
      doFilter: function() {
         return doColorMatrix();
      }
   }, {
      name: "hue", // really: rotation of hue
      doFilter: function() {
         return doColorMatrix();
      }
   }, {
      name: "contrast",
      doFilter: function() {
         return doColorMatrix();
      }
   }, {
      name: "blur",
      doFilter: function() { return null; }
   }, {
      name: "invert",
      doFilter: function() { return null; }
   }, {
      name: "opacity",
      doFilter: function() { return null; }
   }, {
      name: "sepia",
      doFilter: function() { return null; }
   }, {
      name: "drop",
      doFilter: function() { return null; }
   }
];

function multiply(a, b) {
   var t = 0;
   var res = new Float64Array(20);
   for (var i=0, t=0; t < 20; i += 5) {
      for (var j=0; j < 5; ++j, ++t) {
         res[t] = 0;
         for (var k=0, l=i, m=j; k < 4; ++k, ++l, m += 5) {
            res[t] += a[l] * b[m];
         }
      }
      res[t-1] += a[i+4];
   }
   return res;
}
function saturate(s, vals) {
   if (s == 100) {
      return vals;
   }else {
      s /= 100;
      return multiply(
         vals,
         [
            (((1.0-s)*RW) + s), (((1.0-s)*GW)), (((1.0-s)*BW)), 0, 0,
            (((1.0-s)*RW)), (((1.0-s)*GW) + s), (((1.0-s)*BW)), 0, 0,
            (((1.0-s)*RW)), (((1.0-s)*GW)), (((1.0-s)*BW) + s), 0, 0,
            0, 0, 0, 1, 0
         ]
      );
   }
}
function hueRotate(d, vals) {
   var rad = (d * Math.PI) / 180;
   var cos = Math.cos(rad);
   var sin = Math.sin(rad);
   return multiply(
      vals,
      [
         RW+(cos*RX)-(sin*RW), GW-(cos*GW)-(sin*GW), BW-(cos*BW)+(sin*BX), 0, 0,
         RW-(cos*RW)+(sin*RA), GW+(cos*GX)+(sin*GA), BW-(cos*BW)-(sin*BA), 0, 0,
         RW-(cos*RW)-(sin*RX), GW-(cos*GW)+(sin*GW), BW+(cos*BX)+(sin*BW), 0, 0,
         0, 0, 0, 1, 0
      ]
   );
}
function doContrast(d, vals) {
   if (d != 100) {
      d /= 100;
      vals[0] *= (1-RW) * d;
      vals[6] *= (1-GW) * d;
      vals[11] *= (1-BW) * d;
   }
   return vals;
}

function doColorMatrix() {
   var oldR = parseInt(document.getElementById("red").value);
   var oldG = parseInt(document.getElementById("green").value);
   var oldB = parseInt(document.getElementById("blue").value);
   var newR = oldR + ((100-oldG)/2) + ((100-oldB)/2);
   var newG = ((100-oldR)/2) + oldG + ((100-oldB)/2);
   var newB = ((100-oldR)/2) + ((100-oldG)/2) + oldB;
   document.getElementById("blueVal").textContent =  100 - (
      parseInt(document.getElementById("redVal").textContent = (newR/3).toFixed(0)) +
      parseInt(document.getElementById("greenVal").textContent = (newG/3).toFixed(0))
   );
   var brightness = parseInt(document.getElementById("brightness").value);
   document.getElementById("brightnessVal").textContent =  brightness.toFixed(0);
   var saturation = parseInt(document.getElementById("saturation").value);
   document.getElementById("saturationVal").textContent =  saturation.toFixed(0);
   var hue = parseInt(document.getElementById("hue").value); // hue rotation!
   document.getElementById("hueVal").textContent =  hue.toFixed(0);
   var contrast = parseInt(document.getElementById("contrast").value); // contrast rotation!
   document.getElementById("contrastVal").textContent =  contrast.toFixed(0);
   var vals = [
      (newR * (brightness/100))/100, 0, 0, 0, 0,
      0, (newG * (brightness/100))/100, 0, 0, 0,
      0, 0, (newB * (brightness/100))/100, 0, 0,
      0, 0, 0, 1, 0
   ];
   vals = saturate(saturation, vals);
   vals = hueRotate(hue, vals);
   vals = doContrast(contrast, vals);
   var filterValue = "";
   for (var i=0; i < 20; ++i) {
      filterValue += " " + vals[i].toFixed(4);
   }
   document.getElementById("dbg").textContent = filterValue;
   return (
      "data:image/svg+xml;utf8,<svg xmlns='http://www.w3.org/2000/svg'>" +
      "<filter id='f" + this.name +
      "'><feColorMatrix type='matrix' values='" +  filterValue +
      "'/><feComponentTransfer>" +
      "<feFuncR type='linear' slope='" + "2" + "' intercept='-(0.5 * " + "2" + " + 0.5)'/>" +
      "<feFuncG type='linear' slope='" + "2" + "' intercept='-(0.5 * " + "2" + " + 0.5)'/>" +
      "<feFuncB type='linear' slope='" + "2" + "' intercept='-(0.5 * " + "2" + " + 0.5)'/>" +
      "</feComponentTransfer>" +
//    "<feGaussianBlur stdDeviation='4" + "'>" +
      "</filter></svg>#f" + this.name
   );
}

function applyFilter(url) {
   var images = document.querySelectorAll("img.filtered");
   for (var i=0, max=images.length; i < max; ++i) {
      var img = images[i];
      img.style.filter = "url(\"" + url + "\")";
   };

}
window.onload = function() {
   filters.forEach(
      function(filter) {
         var name = filter.name;
         var elt = document.getElementById(name);
         elt.addEventListener(
            'input',
            function() {
               var url = filter.doFilter();
               if (url != null) applyFilter(url);
            }
         );
      }
   );
   applyFilter(doColorMatrix());
}

</SCRIPT>

<TITLE>Testing Filters<</TITLE>
</HEAD>

<BODY>
<DIV>
    <P style="font-size:small">Please use Firefox Nightly for rendering the sliders</P>
    <TABLE style="width: 85%;margin:auto">
      <THEAD><TR>
         <TH scope="col"></TH>
         <TH scope="col"></TH>
      </TR></THEAD>
      <TBODY>
         <TR><TD>
            <IMG
               style="width: 100%;"
               src="Cirques.jpg"
               alt="Cirques"
            />
         </TD><TD>
            <IMG
               class = "filtered"
               style="width: 100%;"
               src="Cirques.jpg"
               alt="Cirques"
            />
         </TD></TR>
         <TR><TD>
            <IMG
               style="width: 100%;"
               src="ClownFishes.jpg"
               alt="Clown Fishes"
            />
         </TD><TD>
            <IMG
               class = "filtered"
               style="width: 100%;"
               src="ClownFishes.jpg"
               alt="Clown Fishes"
            />
         </TD></TR>
         <TR><TD colspan="2" style="height:0.5rem"></TD></TR>
         <TR><TD colspan="2">
            <TABLE class="sliders" width="100%">
               <TBODY>
                 <TR><TD>Red</TD><TD><INPUT id="red" type="range" value="33" min="0" max="100" step="1"/><SPAN id=redVal></SPAN>
                 </TD><TD>Saturation</TD><TD><INPUT id="saturation" value="100" type="range"  min="-100" max="100"/><SPAN id="saturationVal"></SPAN>
                 </TD><TD disabled="disabled">Invert</TD><TD disabled="disabled"><INPUT id="invert" type="range" min="0" max="100"/><SPAN id="invertVal"></SPAN>
                 </TD></TR>
                 <TR><TD>Green</TD><TD><INPUT id="green" type="range" value="33" min="0" max="100" step="1"/><SPAN id="greenVal"></SPAN>
                 </TD><TD>Hue Rotation</TD><TD><INPUT id="hue" type="range" value="0" min="0" max="360"/><SPAN id="hueVal"></SPAN>
                 </TD><TD disabled="disabled">Opacity</TD><TD disabled="disabled"><INPUT id="opacity" type="range" min="0" max="100"/><SPAN id="opacityVal"></SPAN>
                 </TD></TR>
                 <TR><TD>Blue</TD><TD><INPUT id="blue" type="range" value="33" min="0" max="100" step="1"/><SPAN id="blueVal"></SPAN>
                 </TD><TD>Contrast</TD><TD><INPUT id="contrast" value="100" type="range" min="0" max="500"/><SPAN id="contrastVal"></SPAN>
                 </TD><TD disabled="disabled">Drop Shadow</TD><TD disabled="disabled"><INPUT id="drop" type="range" min="0" max="100"/><SPAN id="dropVal"></SPAN>
                 </TD></TR>
                 <TR><TD>Brightness</TD><TD><INPUT id="brightness" value="100" type="range"  min="0" max="100"/><SPAN id="brightnessVal"></SPAN>
                 </TD><TD disabled="disabled">Blur</TD><TD disabled="disabled"><INPUT id="blur" type="range" min="0" max="100"/><SPAN id=blurVal></SPAN>
                 </TD><TD disabled="disabled">Sepia</TD><TD disabled="disabled"><INPUT id="sepia" type="range" min="0" max="100"/><SPAN id="sepiaVal"></SPAN>
                 </TD></TR>
               </TBODY>
            </TABLE>
         </TD></TR>
      </TBODY>
    </TABLE>
  </DIV>
  <DIV id="dbg" style="position:absolute; top:1rem; left:1rem"></DIV>
</BODY></HTML>

